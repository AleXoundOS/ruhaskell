<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" href="../../../../../static/images/favicon.ico">

        <title>Сервер для онлайн профилирования приложений</title>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">

        <link href="../../../../../static/css/default.css" rel="stylesheet">

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
        <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <script>
          window.___gcfg = {
            lang: 'ru'
          };
        </script>

        <script src="https://apis.google.com/js/platform.js" async defer>
        </script>

        <link rel="alternate" type="application/rss+xml" title="RSS" href="http://ruhaskell.org/feed.xml" />

        <script async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
    </head>

  <body>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-58217738-1', 'auto');
      ga('send', 'pageview');

    </script>

    <div class="container">
        <nav class="navbar navbar-default navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <div id="ruhaskell-logo">
                <a class="navbar-brand" href="../../../../../" title="Домой">
                  <img alt="ruHaskell" src="../../../../../static/images/logo.png" width="60">
                </a>
              </div>
            </div>

            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Публикации<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="../../../../../archive.html">
                            <span class="archive-link">
                                <span class="fa fa-pencil"></span>
                            </span>Статьи
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../tags.html">
                            <span class="tags-link">
                                <span class="fa fa-tags"></span>
                            </span>Теги
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../categories.html">
                            <span class="categories-link">
                                <span class="fa fa-star"></span>
                            </span>Категории
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../authors.html">
                            <span class="authors-link">
                                <span class="fa fa-users"></span>
                            </span>Авторы
                        </a>
                    </li>
                  </ul>
                </li>

                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Общение<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://gitter.im/ruHaskell/forall" target="_blank">
                            <span class="chat-link">
                                <span class="fa fa-smile-o"></span>
                            </span>Чат
                        </a>
                    </li>
                    <li>
                        <a href="https://www.reddit.com/r/ruhaskell/" target="_blank">
                            <span class="group-link">
                                <span class="fa fa-reddit-alien"></span>
                            </span>reddit
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../maillist.html">
                            <span class="group-link">
                                <span class="fa fa-group"></span>
                            </span>Список рассылки
                        </a>
                    </li>
                  </ul>
                </li>

                <li><a href="../../../../../links.html">Ссылки</a></li>
              </ul>

              <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Присоединяйтесь!<span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu" role="menu">
                    <li>
                        <a href="https://twitter.com/RuHaskell" target="_blank">
                            <span id="twitter-link">
                                <span class="fa fa-twitter-square"></span>
                            </span>Twitter
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/ruHaskell/ruhaskell" target="_blank">
                            <span id="github-link">
                                <span class="fa fa-github-square"></span>
                            </span>GitHub
                        </a>
                    </li>
                    <li>
                        <a href="https://plus.google.com/communities/117343381540538069054" target="_blank">
                            <span id="google-plus-link">
                                <span class="fa fa-google-plus-square"></span>
                            </span>Google+
                        </a>
                    </li>
                    <li>
                        <a href="../../../../../feed.xml">
                            <span id="rss-link">
                                <span class="fa fa-rss-square"></span>
                            </span>RSS
                        </a>
                    </li>
                    <li>
                        <a href="http://bananasandlenses.net/" target="_blank">
                            <span id="bananasandlenses-link">
                                <span class="fa fa-headphones"></span>
                            </span>Подкаст
                        </a>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>

        <div id="content">
            <h1>Сервер для онлайн профилирования приложений</h1>

<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            <strong>let</strong> author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/Anton%20Gushcha.html">Anton Gushcha</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= fromGregorian 2016 sep 13<br />
            &nbsp;&nbsp;&nbsp;&nbsp;category = "<a href="../../../../../categories/projects.html">Проекты</a>"<br />
            &nbsp;&nbsp;&nbsp;&nbsp;tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/HSOC.html">HSOC</a>&quot;, &quot;<a href="../../../../../tags/eventlog.html">eventlog</a>&quot;, &quot;<a href="../../../../../tags/profiling.html">profiling</a>&quot;]
        </div>
    </div>

    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        
    </div>
</div>

<p>Лето закончилось и вместе с ним завершается студенческая программа <a href="https://summer.haskell.org/">Haskell Summer of Code 2016</a>, которая в этом году заменяет Google Summer of Code для хаскеллистов. Мой проект приняли по счастливой случайности: дополнительный спонсор появился к концу Июня. Итого, у меня было всего два месяца для осуществления проекта, и я думаю, что они не пропали даром.</p>
<h1 id="о-чём-проект">О чём проект</h1>
<p>На текущий момент существует несколько инструментов для профилирования Хаскелль программ:</p>
<ol style="list-style-type: decimal">
<li><p><a href="https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/profiling.html">Сборка с <code>-prof</code></a>, которая позволяет замерять статистику по “cost centers” и использованию heap’а. Для использования этого вида профайлера необходимо перекомпилировать приложение и все его зависимости, что в больших проектах занимает ощутимое время. Но что более важно, это значительный вносимый overhead в работу приложения.</p></li>
<li><p><a href="https://ghc.haskell.org/trac/ghc/wiki/EventLog">Eventlog</a>, который позволяет записывать события GC, планировшика потоков, пользовательские сообщения и прочее. В лог также попадает также статистика использования памяти, но не так детально, как в “настоящем” профилировании. Главной особенностью данного инструмента является то, что он не требует длительной пересборки и дает малый overhead.</p></li>
<li><p><a href="https://ghc.haskell.org/trac/ghc/wiki/Debugging/TickyTicky">Ticky-ticky</a> профайлер – довольно специфическая разновидность, которая добавляет счетчики к каждому объекту на уровне <a href="https://ghc.haskell.org/trac/ghc/wiki/Commentary/Compiler/GeneratedCode">STG</a>. Этот вид профайлера нужен в основном разработчикам GHC.</p></li>
</ol>
<p>Для проблем с многопоточностью, проблем, которые проявляются только под нагрузкой, или просто для вероятностных багов целесообразно записывать eventlog и потом анализировать происходящее через специальные инструменты, например, <a href="https://wiki.haskell.org/ThreadScope">ThreadScope</a> и <a href="http://www.well-typed.com/blog/86/">ghc-events-analyze</a>.</p>
<p>Однако существующая реализация eventlog имеет важный недостаток, которые не позволяет реализовать онлайн профилирование приложений. RTS создает файл для лога и пишет туда все события, гипотетическим инструментам для онлайн профилирования приходилось бы решать проблему чтения из этого файла пока туда ведется запись. Также при значительном потоке сообщений размер лога может прибывать по 100 МБ в минуту, рано или поздно лог займет всё свободное пространство на диске.</p>
<h1 id="цели-проекта">Цели проекта</h1>
<p>Мой HSOC проект направлен на доработку eventlog и реализации proof-of-concept для онлайн профиловщика приложений:</p>
<ol style="list-style-type: decimal">
<li><p>Доработка RTS для возможности перенаправления событий в произвольный файловый дескриптор или передачу событий через память на уровень Haskell. Сюда также входит возможность динамически изменять размер промежуточных буферов лога.</p></li>
<li><p>Разработка приложения-монитора, которое бы перехватывало поток сообщений из профилируемой программы и отдавала его удаленному инструменту для профилирования.</p></li>
<li><p>Разработка удаленного инструмента для отображения eventlog на основе веб приложения.</p></li>
</ol>
<h1 id="результаты">Результаты</h1>
<p>В целом, все три задачи были реализованы. Изначально было запланировано гораздо больше, но по тем или иным причинам от фич пришлось отказываться, в основном, из-за дефицита времени.</p>
<h2 id="rts">RTS</h2>
<p>Изменения RTS оформлены в отдельный <a href="https://ghc.haskell.org/trac/ghc/ticket/12582">тикет</a> и залиты на <a href="https://phabricator.haskell.org/D2522">Phabricator</a>, где их ждёт жесткое ревью и доработка.</p>
<h2 id="monitor">Monitor</h2>
<p>Полный data flow событий от их создания и до прихода в инструмент профиловщика выглядит так:</p>
<div class="figure">
<img src="../../../../../files/posts/2016-09-13/live-profile-monitor-data-flow-ru.png#center" />

</div>
<p><a href="https://github.com/NCrashed/live-profile-monitor">Монитор</a> позволяет подключаться к приложениям, к которым добавлена маленькая <a href="https://github.com/NCrashed/live-profile-monitor/tree/master/live-profile-leech">библиотека-пиявка</a>:</p>
<pre><code>hs-live-profile --RTS myapp +RTS -lm&quot;</code></pre>
<p>и потом передавать сообщения через TCP соединение, где на другом конце профилировщик вешает свои <a href="https://github.com/NCrashed/live-profile-monitor/tree/master/live-profile-client">callback’и</a>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">ClientBehavior</span> <span class="fu">=</span> <span class="dt">ClientBehavior</span> {
<span class="ot">  clientOnHeader ::</span> <span class="fu">!</span>(<span class="dt">Header</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ())  <span class="co">-- ^ Вызывается, когда пришел полный заголовок лога</span>
,<span class="ot"> clientOnEvent ::</span> <span class="fu">!</span>(<span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="co">-- ^ Вызывается, когда пришло новое событие</span>
,<span class="ot"> clientOnService ::</span> <span class="fu">!</span>(<span class="dt">ServiceMsg</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="co">-- ^ Вызывается, когда пришло служебное сообщение</span>
,<span class="ot"> clientOnState ::</span> <span class="fu">!</span>(<span class="dt">EventlogState</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="co">-- ^ Вызывается, когда пришел новый снимок состояния лога</span>
,<span class="ot"> clientOnExit ::</span> <span class="fu">!</span>(<span class="dt">Maybe</span> <span class="dt">SomeException</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()) <span class="co">-- ^ Вызывается при выходе из потока клиента</span>
}</code></pre></div>
<h2 id="сервер-профилировщик">Сервер профилировщик</h2>
<p>Самая сырая часть проекта, так как на нее пришлось самое малое количество времени. Итого, сервер может успешно пародировать <a href="http://www.well-typed.com/blog/86/">ghc-events-analyze</a>, подключаться к монитору, управлять логами через админку:</p>
<div class="figure">
<img src="../../../../../files/posts/2016-09-13/screen-fib-bined.png#center" />

</div>
<p><a href="https://github.com/NCrashed/live-profile-server">Сервер</a> можно развернуть у себя локально, так и попробовать <a href="http://liveprofile.teaspotstudio.ru/">развернутый вариант онлайн</a>. Сейчас есть проблемы с производительностью построения диаграмм, для логов размеров около 50 МБ они могут строятся по 5-7 минут.</p>
<p>Особенностью реализации сервера является то, что он полностью написан на Haskell, в том числе фронтенд, который реализован на GHCJS + <a href="https://github.com/reflex-frp/reflex-platform">reflex</a> + <a href="http://projects.haskell.org/diagrams/#">diagrams</a>, а серверная часть вовсю использует <a href="http://haskell-servant.readthedocs.io/en/stable/">servant</a> и type-level магию.</p>
<h2 id="сопутствующие-библиотеки">Сопутствующие библиотеки</h2>
<p>В процессе написания HSOC проекта я старался выносить все полезные куски кода в отдельные библиотеки:</p>
<ul>
<li><p><a href="http://hackage.haskell.org/package/aeson-injector">aeson-injector</a> - типы “обертки” для инъекции полей в генерируемые JSON’ы.</p></li>
<li><p><a href="http://hackage.haskell.org/package/servant-auth-token-api">servant-auth-token-api</a> и <a href="http://hackage.haskell.org/package/servant-auth-token">servant-auth-token</a> - библиотека для token авторизации для servant. Эта библиотека эксплуатирует модульность servant’а и позволяет с минимальными усилиями встроить авторизацию с пользователями и группами пользователей внутрь своего приложения.</p></li>
</ul>
<h3 id="servant-rest-derive">servant-rest-derive</h3>
<p>В ходе разработки сервера была получена экспериментальная библиотека, которая может только из описания <a href="http://hackage.haskell.org/package/vinyl">vinyl</a> структур вывести RESTful сервер:</p>
<p>Описание API:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="co">-- | Connection to remote application</span>
<span class="kw">type</span> <span class="dt">Connection</span> <span class="fu">=</span> <span class="dt">FieldRec</span> <span class="ch">'[</span>
    <span class="ch">'(&quot;name&quot;, Text)</span>
  , <span class="ch">'(&quot;host&quot;, Text)</span>
  , <span class="ch">'(&quot;port&quot;, Word)</span>
  , <span class="ch">'(&quot;lastUsed&quot;, Maybe UTCTime)</span>
  ]

<span class="kw">instance</span> <span class="dt">Named</span> <span class="dt">Connection</span> <span class="kw">where</span> 
  getName _ <span class="fu">=</span> <span class="st">&quot;Connection&quot;</span>

<span class="co">-- | Correspoinding patch record</span>
<span class="fu">$</span>(declareVinylPatch <span class="ch">''</span><span class="dt">Connection</span>)

<span class="co">-- | API about connections to remote Haskell applications that we profile</span>
<span class="kw">type</span> <span class="dt">ConnectionAPI</span> <span class="fu">=</span> <span class="st">&quot;connection&quot;</span> <span class="fu">:&gt;</span> <span class="dt">RESTFull</span> <span class="dt">Connection</span> <span class="st">&quot;connection&quot;</span></code></pre></div>
<p>Вывод сервера:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">connectionServer ::</span> <span class="dt">ServerT</span> <span class="dt">ConnectionAPI</span> <span class="dt">App</span> 
connectionServer <span class="fu">=</span> restServer (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="ch">'[ '</span><span class="dt">GET</span>, <span class="ch">'POST, '</span><span class="dt">PUT</span>, <span class="ch">'PATCH, '</span><span class="dt">DELETE</span>]) 
  (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="dt">Connection</span>) (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="st">&quot;connection&quot;</span>)
  (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> <span class="dt">App</span>)</code></pre></div>
<p>Данная библиотека заслуживает отдельного поста и будет загружена на Hackage в скором будущем.</p>
<h1 id="будущее-проекта">Будущее проекта</h1>
<p>Я не собираюсь бросать проект, так как он еще далеко от стадии “полезный для реальных применений”. Далее перед мной стоят следующие задачи:</p>
<ul>
<li><p>Пройти код ревью и смержить изменения RTS в GHC. На момент написания поста, в Phabricator уже выразили пару замечаний по документации и реализации, но принципиальных проблем для попадания новых возможностей в GHC нет.</p></li>
<li><p>Добиться real-time отрисовки диаграмм, чтобы графики строились для логов инкрементально, а сервер имел опцию держать в базе только определенное временное окно событий.</p></li>
<li><p>Добавить другие виды графиков и диаграмм. Потенциально сервер может быть полным аналогом ThreadScope и ghc-events-analyze и даже вычленять статистику по используемой памяти.</p></li>
<li><p>Многопользовательский режим использования сервера. Возможность заливать приватные логи на сервер.</p></li>
</ul>
<h1 id="посты-на-английском">Посты на английском</h1>
<p>Более подробно о проекте и моих изысканиях по реализации проекта можно прочесть в блоге на английском языке:</p>
<ul>
<li><p><a href="http://ncrashed.github.io/blog/posts/2016-06-12-hsoc-acceptance.html">Оригинальный proposal проекта</a></p></li>
<li><p><a href="http://ncrashed.github.io/blog/posts/2016-06-22-hsoc-rts.html">Реализация изменений в RTS</a></p></li>
<li><p><a href="http://ncrashed.github.io/blog/posts/2016-07-20-hsoc-monitoring-library.html">Сказ о мониторе</a></p></li>
<li><p><a href="http://ncrashed.github.io/blog/posts/2016-09-11-hsoc-results.html">Отчёт о результатах HSOC</a></p></li>
</ul>

<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

    <div class="g-plus" data-action="share" data-annotation="bubble"></div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

        </div>

        <div id="searchForm">
            <script>
              (function() {
                var cx = '007697214108744450483:w49n7qbvpdy';
                var gcse = document.createElement('script');
                gcse.type = 'text/javascript';
                gcse.async = true;
                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(gcse, s);
              })();
            </script>
            <gcse:search></gcse:search>
        </div>

        <footer class="footer">
            Сайт работает на <strong><a href="http://jaspervdj.be/hakyll/" target="_blank">Hakyll</a></strong> и живёт на <strong><a href="https://github.com/ruHaskell/ruhaskell" target="_blank">GitHub</a></strong>.
            <div class="stargaze">
                <a data-count-api="/repos/ruHaskell/ruhaskell#stargazers_count" data-count-href="/ruHaskell/ruhaskell/stargazers" data-icon="octicon-star" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Star</a>

                <span style="padding-left: 20px;"></span>

                <a data-count-api="/repos/ruHaskell/ruhaskell#forks_count" data-count-href="/ruHaskell/ruhaskell/network" data-icon="octicon-git-branch" href="https://github.com/ruHaskell/ruhaskell" class="github-button">Fork</a>
            </div>

            <div class="copyright-note">
                Исходный код данного сайта, а также все опубликованные на нём материалы распространяются на условиях <a href="https://github.com/ruHaskell/ruhaskell/blob/master/LICENSE" target="_blank">свободной лицензии MIT</a>.
            </div>
        </footer>
    </div>

<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function () {
var s = document.createElement('script'); s.async = true;
s.type = 'text/javascript';
s.src = '//' + disqus_shortname + '.disqus.com/count.js';
(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>

  </body>
</html>
